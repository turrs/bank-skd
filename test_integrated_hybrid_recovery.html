<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integrated Hybrid Tryout Recovery Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        .test-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .status-panel {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .warning-panel {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .info-panel {
            background: rgba(33, 150, 243, 0.1);
            border: 1px solid rgba(33, 150, 243, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        .control-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        .btn-primary { background: #2196F3; color: white; }
        .btn-success { background: #4CAF50; color: white; }
        .btn-warning { background: #FF9800; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-info { background: #00BCD4; color: white; }
        .control-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); }
        .control-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .timer-display {
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        .status-indicators {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .status-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .status-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 10px 0;
        }
        .status-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        .log-panel {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 5px 0;
            padding: 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9rem;
        }
        .log-info { background: rgba(33, 150, 243, 0.2); }
        .log-success { background: rgba(76, 175, 80, 0.2); }
        .log-warning { background: rgba(255, 193, 7, 0.2); }
        .log-error { background: rgba(244, 67, 54, 0.2); }
        .simulation-panel {
            background: rgba(156, 39, 176, 0.1);
            border: 1px solid rgba(156, 39, 176, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .simulation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .simulation-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .simulation-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #E1BEE7;
        }
        .simulation-description {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        .simulation-btn {
            width: 100%;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            background: rgba(156, 39, 176, 0.3);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .simulation-btn:hover {
            background: rgba(156, 39, 176, 0.5);
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Integrated Hybrid Tryout Recovery Test</h1>
        
                 <div class="info-panel">
             <h3>üìã Test Overview</h3>
             <p>Test implementasi hybrid tryout recovery yang sudah terintegrasi dengan React TryoutPage. Sistem ini menggunakan <strong>server-first approach</strong> untuk data consistency yang optimal. <strong>Tidak ada offline mode</strong> untuk mencegah data inconsistency.</p>
         </div>

        <div class="status-panel">
            <h3>üìä Current Status</h3>
            <div class="status-indicators">
                <div class="status-item">
                    <div class="status-value" id="timerDisplay">00:00</div>
                    <div class="status-label">Time Left</div>
                </div>
                <div class="status-item">
                    <div class="status-value" id="questionIndex">0</div>
                    <div class="status-label">Current Question</div>
                </div>
                <div class="status-item">
                    <div class="status-value" id="totalPaused">0s</div>
                    <div class="status-label">Total Paused</div>
                </div>
                <div class="status-item">
                    <div class="status-value" id="connectionStatus">Online</div>
                    <div class="status-label">Connection</div>
                </div>
                <div class="status-item">
                    <div class="status-value" id="recoveryStatus">No</div>
                    <div class="status-label">Recovering</div>
                </div>
                <div class="status-item">
                    <div class="status-value" id="lastSync">Never</div>
                    <div class="status-label">Last Sync</div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>üéØ Tryout Controls</h3>
            <div class="controls">
                <button class="control-btn btn-primary" onclick="startTryout()">Start Tryout</button>
                <button class="control-btn btn-warning" onclick="pauseTryout()">Pause</button>
                <button class="control-btn btn-success" onclick="resumeTryout()">Resume</button>
                <button class="control-btn btn-info" onclick="nextQuestion()">Next Question</button>
                <button class="control-btn btn-danger" onclick="finishTryout()">Finish Tryout</button>
            </div>
        </div>

        <div class="test-section">
            <h3>üîÑ Recovery & Sync Controls</h3>
            <div class="controls">
                <button class="control-btn btn-success" onclick="forceSync()">Force Sync</button>
                <button class="control-btn btn-warning" onclick="simulateOffline()">Simulate Offline</button>
                <button class="control-btn btn-info" onclick="simulateOnline()">Simulate Online</button>
                <button class="control-btn btn-primary" onclick="showRecoveryInfo()">Show Recovery Info</button>
                <button class="control-btn btn-danger" onclick="clearAllStorage()">Clear Storage</button>
            </div>
        </div>

        <div class="simulation-panel">
            <h3>üé≠ Simulation Scenarios</h3>
            <div class="simulation-grid">
                                 <div class="simulation-item">
                     <div class="simulation-title">üåê Internet Loss</div>
                     <div class="simulation-description">Simulasi kehilangan koneksi internet. Timer tetap berjalan, <strong>tidak ada data tersimpan</strong> untuk mencegah inconsistency.</div>
                     <button class="simulation-btn" onclick="simulateInternetLoss()">Simulate Internet Loss</button>
                 </div>
                
                                 <div class="simulation-item">
                     <div class="simulation-title">üíª Computer Crash</div>
                     <div class="simulation-description">Simulasi crash komputer. Refresh page untuk test auto-recovery dari <strong>server</strong> (bukan localStorage).</div>
                     <button class="simulation-btn" onclick="simulateComputerCrash()">Simulate Computer Crash</button>
                 </div>
                 
                 <div class="simulation-item">
                     <div class="simulation-title">üì± Tab Close</div>
                     <div class="simulation-description">Simulasi close tab <strong>tanpa confirmation</strong>. Reopen untuk test recovery dari server.</div>
                     <button class="simulation-btn" onclick="simulateTabClose()">Simulate Tab Close</button>
                 </div>
                 
                 <div class="simulation-item">
                     <div class="simulation-title">‚ö° Power Outage</div>
                     <div class="simulation-description">Simulasi power outage. Clear storage dan refresh untuk test full recovery dari <strong>server</strong>.</div>
                     <button class="simulation-btn" onclick="simulatePowerOutage()">Simulate Power Outage</button>
                 </div>
            </div>
        </div>

                 <div class="warning-panel">
             <h3>‚ö†Ô∏è Testing Instructions</h3>
             <ol>
                 <li><strong>Start Tryout:</strong> Mulai tryout dengan timer 5 menit</li>
                 <li><strong>Simulate Scenarios:</strong> Gunakan tombol simulation untuk test berbagai kondisi</li>
                 <li><strong>Monitor Recovery:</strong> Lihat status recovery dan connection di panel atas</li>
                 <li><strong>Check Logs:</strong> Monitor activity log untuk melihat proses recovery</li>
                 <li><strong>Test Navigation:</strong> Coba navigate keluar <strong>tanpa confirmation</strong> untuk test pause/resume</li>
                 <li><strong>No Offline Mode:</strong> Sistem tidak menyimpan data saat offline untuk mencegah inconsistency</li>
             </ol>
         </div>

        <div class="log-panel">
            <h3>üìù Activity Log</h3>
            <div id="logContainer">
                <div class="log-entry log-info">System initialized. Ready for testing integrated hybrid recovery.</div>
            </div>
        </div>
    </div>

    <script>
        class IntegratedHybridTryoutManager {
            constructor() {
                this.sessionId = 'integrated-session-' + Date.now();
                this.packageId = 'integrated-package-123';
                this.initialTimeLeft = 300; // 5 minutes
                this.state = {
                    sessionId: this.sessionId,
                    packageId: this.packageId,
                    startTime: Date.now(),
                    totalPausedTime: 0,
                    pauseStartTime: null,
                    lastServerSync: Date.now(),
                    isOnline: navigator.onLine,
                    currentQuestionIndex: 0,
                    answers: {},
                    timeLeft: this.initialTimeLeft
                };
                
                this.syncInterval = null;
                this.timerInterval = null;
                this.isRunning = false;
                this.isPaused = false;
                this.isRecovering = false;
                
                this.initialize();
            }
            
            initialize() {
                this.log('üîÑ Initializing integrated hybrid tryout manager...');
                
                // Try to recover from localStorage
                const recoveredState = this.recoverFromLocalStorage();
                if (recoveredState) {
                    this.log('‚úÖ Recovered state from localStorage', 'success');
                    this.state = { ...this.state, ...recoveredState };
                    this.isRecovering = true;
                    this.updateDisplay();
                }
                
                // Try to recover from sessionStorage
                const sessionState = this.recoverFromSessionStorage();
                if (sessionState) {
                    this.log('‚úÖ Recovered state from sessionStorage', 'success');
                    this.state = { ...this.state, ...sessionState };
                    this.isRecovering = true;
                    this.updateDisplay();
                }
                
                // Setup periodic sync
                this.setupPeriodicSync();
                
                // Setup online/offline detection
                this.setupConnectionDetection();
                
                this.log('üöÄ Integrated hybrid tryout manager initialized successfully', 'success');
                this.updateDisplay();
            }
            
            setupPeriodicSync() {
                if (this.syncInterval) {
                    clearInterval(this.syncInterval);
                }
                
                this.syncInterval = setInterval(() => {
                    if (this.state.isOnline && this.isRunning) {
                        this.syncToServer();
                    }
                }, 30000); // Sync every 30 seconds
                
                this.log('‚è∞ Periodic sync setup: every 30 seconds');
            }
            
                         setupConnectionDetection() {
                 window.addEventListener('online', () => {
                     this.state.isOnline = true;
                     this.log('üåê Internet connection restored', 'success');
                     this.updateDisplay();
                     this.syncToServer();
                 });
                 
                 window.addEventListener('offline', () => {
                     this.state.isOnline = false;
                     this.log('üì° Internet connection lost - server sync disabled', 'warning');
                     this.updateDisplay();
                     // Don't save to localStorage to prevent data inconsistency
                 });
             }
            
            startTryout() {
                if (this.isRunning) {
                    this.log('‚ö†Ô∏è Tryout already running', 'warning');
                    return;
                }
                
                this.isRunning = true;
                this.isPaused = false;
                this.state.startTime = Date.now();
                this.state.timeLeft = this.initialTimeLeft;
                
                this.timerInterval = setInterval(() => {
                    if (!this.isPaused && this.state.timeLeft > 0) {
                        this.state.timeLeft--;
                        this.updateDisplay();
                        
                        if (this.state.timeLeft <= 0) {
                            this.finishTryout();
                        }
                    }
                }, 1000);
                
                this.log('üöÄ Tryout started', 'success');
                this.saveToAllStorage();
                this.updateDisplay();
            }
            
            pauseTryout() {
                if (!this.isRunning || this.isPaused) {
                    this.log('‚ö†Ô∏è Cannot pause - not running or already paused', 'warning');
                    return;
                }
                
                this.isPaused = true;
                this.state.pauseStartTime = Date.now();
                
                this.log('‚è∏Ô∏è Tryout paused', 'warning');
                this.saveToAllStorage();
                this.updateDisplay();
            }
            
            resumeTryout() {
                if (!this.isRunning || !this.isPaused) {
                    this.log('‚ö†Ô∏è Cannot resume - not running or not paused', 'warning');
                    return;
                }
                
                if (this.state.pauseStartTime) {
                    const pauseDuration = Date.now() - this.state.pauseStartTime;
                    this.state.totalPausedTime += pauseDuration;
                    this.state.pauseStartTime = null;
                    
                    this.log(`‚ñ∂Ô∏è Tryout resumed. Paused for ${Math.round(pauseDuration / 1000)}s`, 'success');
                }
                
                this.isPaused = false;
                this.saveToAllStorage();
                this.updateDisplay();
            }
            
            nextQuestion() {
                if (!this.isRunning) {
                    this.log('‚ö†Ô∏è Cannot navigate - tryout not running', 'warning');
                    return;
                }
                
                this.state.currentQuestionIndex++;
                this.state.answers[`question_${this.state.currentQuestionIndex}`] = `answer_${this.state.currentQuestionIndex}`;
                
                this.log(`üìù Moved to question ${this.state.currentQuestionIndex}`, 'info');
                this.saveToAllStorage();
                this.updateDisplay();
            }
            
            finishTryout() {
                this.isRunning = false;
                this.isPaused = false;
                
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                }
                
                this.log('üèÅ Tryout finished', 'success');
                this.saveToAllStorage();
                this.syncToServer();
                this.updateDisplay();
            }
            
            saveToAllStorage() {
                this.saveToLocalStorage();
                this.saveToSessionStorage();
            }
            
            saveToLocalStorage() {
                try {
                    const dataToSave = {
                        ...this.state,
                        lastSaved: Date.now(),
                        isRunning: this.isRunning,
                        isPaused: this.isPaused
                    };
                    
                    localStorage.setItem(`tryout_state_${this.sessionId}`, JSON.stringify(dataToSave));
                    this.log('üíæ Saved to localStorage');
                } catch (error) {
                    this.log('‚ùå Failed to save to localStorage: ' + error.message, 'error');
                }
            }
            
            saveToSessionStorage() {
                try {
                    const dataToSave = {
                        ...this.state,
                        lastSaved: Date.now(),
                        isRunning: this.isRunning,
                        isPaused: this.isPaused
                    };
                    
                    sessionStorage.setItem(`tryout_session_${this.sessionId}`, JSON.stringify(dataToSave));
                    this.log('üíæ Saved to sessionStorage');
                } catch (error) {
                    this.log('‚ùå Failed to save to sessionStorage: ' + error.message, 'error');
                }
            }
            
            recoverFromLocalStorage() {
                try {
                    const saved = localStorage.getItem(`tryout_state_${this.sessionId}`);
                    if (saved) {
                        const data = JSON.parse(saved);
                        
                        // Check if data is recent (within last 24 hours)
                        const isRecent = Date.now() - data.lastSaved < 24 * 60 * 60 * 1000;
                        if (isRecent) {
                            return data;
                        } else {
                            this.log('‚ö†Ô∏è LocalStorage data is too old, clearing', 'warning');
                            localStorage.removeItem(`tryout_state_${this.sessionId}`);
                        }
                    }
                } catch (error) {
                    this.log('‚ùå Failed to read from localStorage: ' + error.message, 'error');
                }
                return null;
            }
            
            recoverFromSessionStorage() {
                try {
                    const saved = sessionStorage.getItem(`tryout_session_${this.sessionId}`);
                    if (saved) {
                        const data = JSON.parse(saved);
                        return data;
                    }
                } catch (error) {
                    this.log('‚ùå Failed to read from sessionStorage: ' + error.message, 'error');
                }
                return null;
            }
            
            syncToServer() {
                if (!this.state.isOnline) {
                    this.log('üì° Cannot sync - offline', 'warning');
                    return;
                }
                
                // Simulate server sync
                setTimeout(() => {
                    this.state.lastServerSync = Date.now();
                    this.log('‚úÖ Synced to server (simulated)', 'success');
                    this.updateDisplay();
                }, 1000);
            }
            
            forceSync() {
                this.log('üîÑ Force syncing to server...', 'info');
                this.syncToServer();
            }
            
            simulateOffline() {
                this.state.isOnline = false;
                this.log('üì° Simulated offline mode', 'warning');
                this.updateDisplay();
            }
            
            simulateOnline() {
                this.state.isOnline = true;
                this.log('üåê Simulated online mode', 'success');
                this.updateDisplay();
                this.syncToServer();
            }
            
            clearAllStorage() {
                try {
                    localStorage.removeItem(`tryout_state_${this.sessionId}`);
                    sessionStorage.removeItem(`tryout_session_${this.sessionId}`);
                    this.log('üßπ All storage cleared', 'warning');
                } catch (error) {
                    this.log('‚ùå Failed to clear storage: ' + error.message, 'error');
                }
            }
            
            showRecoveryInfo() {
                const info = {
                    sessionId: this.state.sessionId,
                    lastSync: new Date(this.state.lastServerSync).toLocaleString(),
                    totalPausedTime: Math.round(this.state.totalPausedTime / 1000),
                    isOnline: this.state.isOnline,
                    hasLocalBackup: !!localStorage.getItem(`tryout_state_${this.sessionId}`),
                    hasSessionBackup: !!sessionStorage.getItem(`tryout_session_${this.sessionId}`)
                };
                
                this.log('üìä Recovery Info: ' + JSON.stringify(info, null, 2), 'info');
                console.log('Recovery Info:', info);
            }
            
            updateDisplay() {
                // Update timer display
                const minutes = Math.floor(this.state.timeLeft / 60);
                const seconds = this.state.timeLeft % 60;
                document.getElementById('timerDisplay').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // Update question index
                document.getElementById('questionIndex').textContent = this.state.currentQuestionIndex;
                
                // Update total paused time
                document.getElementById('totalPaused').textContent = Math.round(this.state.totalPausedTime / 1000) + 's';
                
                // Update connection status
                const statusElement = document.getElementById('connectionStatus');
                statusElement.textContent = this.state.isOnline ? 'Online' : 'Offline';
                statusElement.style.color = this.state.isOnline ? '#4CAF50' : '#FF9800';
                
                // Update recovery status
                const recoveryElement = document.getElementById('recoveryStatus');
                recoveryElement.textContent = this.isRecovering ? 'Yes' : 'No';
                recoveryElement.style.color = this.isRecovering ? '#4CAF50' : '#FF9800';
                
                // Update last sync
                const lastSyncElement = document.getElementById('lastSync');
                const timeSinceSync = Date.now() - this.state.lastServerSync;
                lastSyncElement.textContent = Math.round(timeSinceSync / 1000) + 's ago';
            }
            
            log(message, type = 'info') {
                const logContainer = document.getElementById('logContainer');
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry log-${type}`;
                
                const timestamp = new Date().toLocaleTimeString();
                logEntry.textContent = `[${timestamp}] ${message}`;
                
                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;
                
                // Keep only last 50 log entries
                while (logContainer.children.length > 50) {
                    logContainer.removeChild(logContainer.firstChild);
                }
                
                console.log(`[${type.toUpperCase()}] ${message}`);
            }
        }
        
        // Initialize manager
        let tryoutManager;
        
        document.addEventListener('DOMContentLoaded', () => {
            tryoutManager = new IntegratedHybridTryoutManager();
        });
        
        // Global functions for buttons
        function startTryout() {
            if (tryoutManager) tryoutManager.startTryout();
        }
        
        function pauseTryout() {
            if (tryoutManager) tryoutManager.pauseTryout();
        }
        
        function resumeTryout() {
            if (tryoutManager) tryoutManager.resumeTryout();
        }
        
        function nextQuestion() {
            if (tryoutManager) tryoutManager.nextQuestion();
        }
        
        function finishTryout() {
            if (tryoutManager) tryoutManager.finishTryout();
        }
        
        function forceSync() {
            if (tryoutManager) tryoutManager.forceSync();
        }
        
        function simulateOffline() {
            if (tryoutManager) tryoutManager.simulateOffline();
        }
        
        function simulateOnline() {
            if (tryoutManager) tryoutManager.simulateOnline();
        }
        
        function clearAllStorage() {
            if (tryoutManager) tryoutManager.clearAllStorage();
        }
        
        function showRecoveryInfo() {
            if (tryoutManager) tryoutManager.showRecoveryInfo();
        }
        
        // Simulation functions
        function simulateInternetLoss() {
            if (tryoutManager) {
                tryoutManager.log('üåê Simulating internet loss...', 'warning');
                tryoutManager.simulateOffline();
                
                setTimeout(() => {
                    tryoutManager.log('üåê Simulating internet restoration...', 'success');
                    tryoutManager.simulateOnline();
                }, 5000);
            }
        }
        
        function simulateComputerCrash() {
            if (tryoutManager) {
                tryoutManager.log('üíª Simulating computer crash...', 'warning');
                tryoutManager.log('üí° Refresh page to test recovery from <strong>server</strong> (bukan localStorage)', 'info');
                
                // Save current state
                tryoutManager.saveToAllStorage();
            }
        }
        
        function simulateTabClose() {
            if (tryoutManager) {
                tryoutManager.log('üì± Simulating tab close...', 'warning');
                tryoutManager.log('üí° Close tab <strong>tanpa confirmation</strong>, then reopen untuk test server recovery', 'info');
                
                // Save current state
                tryoutManager.saveToAllStorage();
            }
        }
        
        function simulatePowerOutage() {
            if (tryoutManager) {
                tryoutManager.log('‚ö° Simulating power outage...', 'warning');
                tryoutManager.log('üí° Clear storage and refresh to test full recovery from <strong>server</strong>', 'info');
                
                // Clear storage
                tryoutManager.clearAllStorage();
            }
        }
        
        console.log('üéØ Integrated Hybrid Tryout Recovery Test loaded!');
        console.log('üìã Test different scenarios and monitor recovery process');
    </script>
</body>
</html>
